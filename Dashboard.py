import streamlit as st
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns

st.title("Interactief Data Dashboard - Meerdere bestanden uploaden")

# Meerdere bestanden uploaden
uploaded_files = st.file_uploader(
    "Upload Ã©Ã©n of meerdere CSV/Excel bestanden",
    type=["csv", "xlsx"],
    accept_multiple_files=True
)

if uploaded_files:
    data_frames = []

    # Bestanden inlezen
    for uploaded_file in uploaded_files:
        if uploaded_file.name.endswith('.csv'):
            df = pd.read_csv(uploaded_file)
        else:
            df = pd.read_excel(uploaded_file)
        data_frames.append(df)

    # Combineer alle bestanden
    combined_df = pd.concat(data_frames, ignore_index=True)
    st.success(f"{len(uploaded_files)} bestanden succesvol gecombineerd!")

    #%% Data opschonen en verwerken
    combined_df['Date and time'] = pd.to_datetime(combined_df['Date and time'], format='%d-%m-%Y %H:%M:%S.%f')
    combined_df['kind'] = combined_df['Location'].str.split('/').str[-1].str.strip()
    combined_df['Date'] = combined_df['Date and time'].dt.date
    combined_df['Time'] = combined_df['Date and time'].dt.time
    combined_df['Prioriteit'] = np.where(
        combined_df['Flow name'].str.contains('MDDG_prioriteit_Medium_alarm_Raise'), 'Medium',
        np.where(
            combined_df['Flow name'].str.contains('MDDG_prioriteit_Hoog_alarm_Raise'), 'High',
            'Overig'
        )
    )
    combined_df['id'] = combined_df['Flow execution id']
    combined_df['Message'] = combined_df['Autogenerated message']

    # Bewaar Location voor heatmap
    combined_df['Location_kopie'] = combined_df['Location']

    # Verwijder ongewenste kolommen
    combined_df = combined_df.drop(columns=['Flow name', 'Flow execution id', 'Location', 'Flow group', 'Autogenerated message'])

    # Data splitsen
    split_date = pd.to_datetime('2024-11-26').date()
    combined2_df = combined_df[combined_df['Date'] > split_date].copy()
    combined_df = combined_df[combined_df['Date'] < split_date].copy()

    finished_df = combined_df[combined_df['Status'] == 'Finished']
    deliverd_df = combined_df[combined_df['Status'] == 'Delivered']

    finished2_df = combined2_df[combined2_df['Status'] == 'Finished']
    deliverd2_df = combined2_df[combined2_df['Status'] == 'Delivered']

    df = pd.DataFrame(finished_df)
    dfd = pd.DataFrame(deliverd_df)
    df2 = pd.DataFrame(finished2_df)
    dfd2 = pd.DataFrame(deliverd2_df)

    # Datum bereik selectie
    min_date = combined_df['Date'].min()
    max_date = combined_df['Date'].max()
    selected_dates = st.date_input(
        "Selecteer datum bereik voor grafieken:",
        value=(min_date, max_date),
        min_value=min_date,
        max_value=max_date
    )

    # Zorg dat het altijd een tuple van twee datums is
    if isinstance(selected_dates, tuple):
        start_date, end_date = selected_dates
    else:
        start_date = end_date = selected_dates

    # Filter de data op het geselecteerde bereik
    filtered_finished = df[(df['Date'] >= start_date) & (df['Date'] <= end_date)]
    filtered_delivered = dfd[(dfd['Date'] >= start_date) & (dfd['Date'] <= end_date)]

    # ---------------- LINE PLOT ----------------
    delivered_counts = filtered_delivered.groupby('Date').size()
    finished_counts = filtered_finished.groupby('Date').size()

    plot_df = pd.DataFrame({
        'Delivered': delivered_counts,
        'Finished': finished_counts
    }).fillna(0)

    avg_delivered = plot_df['Delivered'].mean() if not plot_df.empty else 0
    avg_finished = plot_df['Finished'].mean() if not plot_df.empty else 0

    plt.figure(figsize=(12, 6))
    plot_df.plot(kind='line', marker='o', ax=plt.gca())
    plt.axhline(y=avg_delivered, color='blue', linestyle='--', label=f'Gem. Delivered ({avg_delivered:.1f})')
    plt.axhline(y=avg_finished, color='orange', linestyle='--', label=f'Gem. Finished ({avg_finished:.1f})')
    plt.title(f'Aantal meldingen per dag (Delivered & Finished) van {start_date} tot {end_date}')
    plt.xlabel('Datum')
    plt.ylabel('Aantal meldingen')
    plt.grid(True)
    plt.xticks(rotation=45)
    plt.tight_layout()
    plt.legend(title='Status')
    st.pyplot(plt)

    # ---------------- HEATMAP ----------------
    # Kamer extractie uit Location_kopie
    deliverd_df['kamer'] = deliverd_df['Location_kopie'].str.split('/').str[-1].str.strip()
    heatmap_df = deliverd_df[(deliverd_df['Date'] >= start_date) & (deliverd_df['Date'] <= end_date)]

    if not heatmap_df.empty:
        heatmap_data = heatmap_df.groupby(['Date', 'kamer']).size().reset_index(name='Aantal')
        pivot_table = heatmap_data.pivot(index='Date', columns='kamer', values='Aantal').fillna(0)

        plt.figure(figsize=(12, 6))
        sns.heatmap(pivot_table, annot=True, fmt=".0f", cmap='YlOrRd', cbar_kws={'label': 'Aantal Delivered alarms'})
        plt.title(f'Heatmap van Delivered alarms per kamer van {start_date} tot {end_date}')
        plt.xlabel('Kamer')
        plt.ylabel('Datum')
        plt.tight_layout()
        st.pyplot(plt)
    else:
        st.info("Geen Delivered alarms in het geselecteerde datum bereik voor de heatmap.")
